name: Orchestrate Work Item (Issue -> Gemini -> Release)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: GitHub Issue number for WI-### issue
        required: true
      role_guide:
        description: Optional override. Role guide file under agent_guides/
        required: false
        default: ""
      artifact_type:
        description: Optional override (repo_patch or pipeline_snapshot)
        required: false
        default: ""
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch')
      || (github.event_name == 'issues'
          && github.actor == 'github-actions'
          && startsWith(github.event.issue.title, 'Work Item:'))
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Disable Python bytecode
        run: echo "PYTHONDONTWRITEBYTECODE=1" >> "$GITHUB_ENV"

      - name: Run orchestrator
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ROLE_GUIDE=""
            ARTIFACT_TYPE=""
          else
            ISSUE_NUMBER="${{ inputs.issue_number }}"
            ROLE_GUIDE="${{ inputs.role_guide }}"
            ARTIFACT_TYPE="${{ inputs.artifact_type }}"
          fi
          python3 tools/orchestrator/run_wi.py "${ISSUE_NUMBER}" "${ROLE_GUIDE}" "${ARTIFACT_TYPE}"
