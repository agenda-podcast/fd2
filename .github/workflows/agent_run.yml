name: fd-agent-run

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      pipeline_id:
        description: "Pipeline id (example: P-20260225-001)"
        required: true
        type: string
      work_item:
        description: "Work Item ID (example: WI-002)"
        required: true
        type: string
      role:
        description: "Role id (example: tech_lead)"
        required: true
        type: string
      task:
        description: "Task text"
        required: true
        type: string
      next_role:
        description: "Next role id (empty means pipeline complete)"
        required: false
        type: string
      next_task:
        description: "Next task for next role"
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  run:
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues' && github.event.label.name == 'agent-run')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build input payload
        run: |
          set -e
          mkdir -p tools
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            cat > tools/issue_input.json <<'JSON'
          {
            "pipeline_id": "${{ inputs.pipeline_id }}",
            "work_item": "${{ inputs.work_item }}",
            "role": "${{ inputs.role }}",
            "task": "${{ inputs.task }}",
            "next_role": "${{ inputs.next_role }}",
            "next_task": "${{ inputs.next_task }}",
            "actions": []
          }
          JSON
          else
            python tools/parse_issue_json.py               --issue-number "${{ github.event.issue.number }}"               --issue-body "${{ github.event.issue.body }}"               --out tools/issue_input.json
          fi

      - name: Determine pipeline branch
        id: br
        run: |
          set -e
          pid=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['pipeline_id'])")
          echo "pid=$pid" >> $GITHUB_OUTPUT
          echo "branch=pipeline/$pid" >> $GITHUB_OUTPUT

      - name: Checkout or create pipeline branch
        run: |
          set -e
          BR="${{ steps.br.outputs.branch }}"
          git config user.name "fd-agent-bot"
          git config user.email "fd-agent-bot@users.noreply.github.com"
          if git show-ref --verify --quiet "refs/remotes/origin/$BR"; then
            git checkout -b "$BR" "origin/$BR"
          else
            git checkout -b "$BR"
          fi

      - name: Run agent pipeline (writes outputs + ZIP)
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['role'])")
          OUTDIR="evidence/${WI}/${ROLE}"
          mkdir -p "$OUTDIR"
          python tools/agent_pipeline.py --input tools/issue_input.json --out "$OUTDIR"
          ls -la "$OUTDIR"

      - name: Upload agent artifacts (short retention)
        uses: actions/upload-artifact@v4
        with:
          name: fd-agent-artifacts
          retention-days: 1
          path: |
            evidence/**/ARTIFACTS.zip
            evidence/**/AGENT_OUTPUT.md
            evidence/**/AGENT_META.json

- name: Cleanup ZIP artifacts before commit
  run: |
    set -e
    find evidence -type f -name "ARTIFACTS.zip" -print -delete || true
    echo "[fd][agent] cleaned ARTIFACTS.zip from workspace"

      - name: Commit artifacts and changes to pipeline branch
        run: |
          set -e
          git add evidence tools/issue_input.json || true
          if [ -n "$(git status --porcelain)" ]; then
            WI=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['work_item'])")
            ROLE=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['role'])")
            git commit -m "$WI $ROLE artifacts"
            git push origin "${{ steps.br.outputs.branch }}"
          else
            echo "[fd][agent] no changes to commit"
          fi

      - name: Create next agent issue (if next_role set)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          nr=$(python -c "import json;print(json.load(open('tools/issue_input.json')).get('next_role','') or '')")
          if [ -z "$nr" ]; then
            echo "[fd][agent] no next_role; pipeline complete"
            exit 0
          fi
          pid=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['pipeline_id'])")
          wi=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['work_item'])")
          nt=$(python -c "import json;print(json.load(open('tools/issue_input.json')).get('next_task','') or '')")
          title="$wi next: $nr"
          body=$(python - <<'PY'
import json
j=json.load(open("tools/issue_input.json"))
out={
  "pipeline_id": j["pipeline_id"],
  "work_item": j["work_item"],
  "role": j.get("next_role",""),
  "task": j.get("next_task",""),
  "next_role": "",
  "next_task": "",
  "actions": []
}
print(json.dumps(out, indent=2))
PY
)
          gh issue create --title "$title" --body "$body" --label "agent-run"

      - name: Open PR when pipeline complete (issues trigger only)
        if: ${{ github.event_name != 'workflow_dispatch' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          nr=$(python -c "import json;print(json.load(open('tools/issue_input.json')).get('next_role','') or '')")
          if [ -n "$nr" ]; then
            echo "[fd][agent] pipeline not complete; PR not opened"
            exit 0
          fi
          pid=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['pipeline_id'])")
          wi=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['work_item'])")
          br="pipeline/$pid"
          gh pr create --title "$wi pipeline complete ($pid)"             --body "Pipeline $pid complete. Branch: $br. Includes all accumulated artifacts and changes. CI must pass."             --base main --head "$br" || true
