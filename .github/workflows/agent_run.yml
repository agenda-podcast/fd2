name: fd-agent-run

on:
  workflow_dispatch:
    inputs:
      pipeline_id:
        description: "Pipeline id (example: P-20260225-001)"
        required: true
        default: "P-20260225-001"
        type: string
      work_item:
        description: "Work Item ID (example: WI-001)"
        required: true
        default: "WI-001"
        type: string
      role:
        description: "Role id (example: pm)"
        required: true
        default: "pm"
        type: string
      task:
        description: "Task text"
        required: true
        default: "Define next step"
        type: string
      next_role:
        description: "Next role id (empty means infer next role)"
        required: false
        default: ""
        type: string
      next_task:
        description: "Next task for next role (optional)"
        required: false
        default: ""
        type: string
      issue_number:
        description: "Issue number to comment on (for workflow_dispatch runs)"
        required: false
        default: ""
        type: string

  issues:
    types:
      - opened
      - edited
      - labeled

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  run:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-run'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build input payload
        env:
          FD_PIPELINE_ID: ${{ inputs.pipeline_id }}
          FD_WORK_ITEM: ${{ inputs.work_item }}
          FD_ROLE: ${{ inputs.role }}
          FD_TASK: ${{ inputs.task }}
          FD_NEXT_ROLE: ${{ inputs.next_role }}
          FD_NEXT_TASK: ${{ inputs.next_task }}
          FD_ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          set -e
          TMP=/tmp/fd_issue_input.json
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            python3 - <<'PY'
import json, os
out = {
    "pipeline_id": os.environ["FD_PIPELINE_ID"],
    "work_item": os.environ["FD_WORK_ITEM"],
    "role": os.environ["FD_ROLE"],
    "task": os.environ["FD_TASK"],
    "next_role": os.environ.get("FD_NEXT_ROLE", ""),
    "next_task": os.environ.get("FD_NEXT_TASK", ""),
    "actions": [],
    "issue_number": os.environ.get("FD_ISSUE_NUMBER", ""),
}
with open("/tmp/fd_issue_input.json", "w", encoding="utf-8", newline="\n") as f:
    f.write(json.dumps(out, indent=2) + "\n")
PY
          else
            python tools/parse_github_event.py \
              --event-path "$GITHUB_EVENT_PATH" \
              --out "$TMP"
          fi

      - name: Determine pipeline branch
        id: br
        run: |
          set -e
          pid=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          echo "pid=$pid" >> $GITHUB_OUTPUT
          echo "branch=pipeline/$pid" >> $GITHUB_OUTPUT

      - name: Checkout or create pipeline branch
        run: |
          set -e
          BR="${{ steps.br.outputs.branch }}"
          git config user.name "fd-agent-bot"
          git config user.email "fd-agent-bot@users.noreply.github.com"
          if git show-ref --verify --quiet "refs/remotes/origin/$BR"; then
            git checkout -b "$BR" "origin/$BR"
          else
            git checkout -b "$BR"
          fi

      - name: Sync tools from main
        run: |
          set -e
          git fetch origin main
          git checkout origin/main -- tools

      - name: Materialize issue_input.json into repo
        run: |
          set -e
          mkdir -p tools
          cp -f /tmp/fd_issue_input.json tools/issue_input.json

      - name: Run agent pipeline
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
          OUTDIR="evidence/${WI}/${ROLE}"
          mkdir -p "$OUTDIR"
          python tools/agent_pipeline.py --input tools/issue_input.json --out "$OUTDIR"

      - name: Upload agent artifacts (short retention)
        uses: actions/upload-artifact@v4
        with:
          name: fd-agent-artifacts
          retention-days: 1
          path: |
            evidence/**/ARTIFACTS.zip
            evidence/**/AGENT_OUTPUT.md
            evidence/**/AGENT_META.json

      - name: Publish ZIP as Release asset (tangible)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
          PID=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          ASSET_PATH=$(ls -1 evidence/"$WI"/"$ROLE"/ARTIFACTS.zip | head -n 1)
          TAG="fd-artifact-${WI}-${ROLE}-${{ github.run_id }}"
          TITLE="FD Artifact ${WI} ${ROLE} run ${{ github.run_id }}"
          gh release create "$TAG" "$ASSET_PATH" --title "$TITLE" --notes "Auto-published agent artifact for $WI/$ROLE (pipeline $PID)." --prerelease --latest=false || \
            gh release upload "$TAG" "$ASSET_PATH" --clobber
          REL_URL="https://github.com/${{ github.repository }}/releases/tag/$TAG"
          echo "$REL_URL" > tools/_artifact_release_url.txt

      - name: Cleanup ZIP artifacts before commit
        run: |
          set -e
          find evidence -type f -name "ARTIFACTS.zip" -print -delete || true
          rm -f tools/next_step.json || true
          rm -f tools/next_issue_body.json || true
          
      - name: Commit artifacts to pipeline branch
        run: |
          set -e
          git add evidence tools/issue_input.json || true
          if [ -n "$(git status --porcelain)" ]; then
            WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
            ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
            git commit -m "$WI $ROLE artifacts"
            git push origin "${{ steps.br.outputs.branch }}"
          fi

      - name: Comment back with artifact link and pipeline branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
          PID=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BR="pipeline/$PID"
          # If release URL file exists, include it; otherwise blank.
          REL_URL=""
          if [ -f tools/_artifact_release_url.txt ]; then REL_URL=$(cat tools/_artifact_release_url.txt); fi
          ISSUE_NUM=$(python -c "import json;v=(json.load(open('tools/issue_input.json')).get('issue_number') or '').strip();print(v)")
          if [ -z "$ISSUE_NUM" ] && [ "${{ github.event_name }}" = "issues" ]; then ISSUE_NUM="${{ github.event.issue.number }}"; fi
          if [ -n "$ISSUE_NUM" ]; then
            gh issue comment "$ISSUE_NUM" --body "Agent ran role=$ROLE work_item=$WI pipeline=$PID. Pipeline branch: $BR. Tangible ZIP (Release asset): $REL_URL . Run: $RUN_URL"
          else
            echo "[fd][agent] no issue_number available; skipping comment"
          fi

      - name: Create next agent issue and auto-start next run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          python tools/next_step.py > tools/next_step.json
          NR=$(python -c "import json;print(json.load(open('tools/next_step.json'))['next_role'])")
          NT=$(python -c "import json;print(json.load(open('tools/next_step.json'))['next_task'])")
          if [ -z "$NR" ]; then
            echo "[fd][agent] pipeline complete (no next role)"
            exit 0
          fi

          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          PID=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          BR="pipeline/$PID"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REL_URL=""
          if [ -f tools/_artifact_release_url.txt ]; then REL_URL=$(cat tools/_artifact_release_url.txt); fi

          TITLE="$WI next: $NR"

          python tools/build_next_issue_body.py \
            --issue-input tools/issue_input.json \
            --role "$NR" \
            --task "$NT" \
            --out tools/next_issue_body.json

          # Store metadata separately; do NOT append to the JSON file (breaks JSON parsing)
          BODY=$(cat tools/next_issue_body.json)

          URL=$(gh issue create --title "$TITLE" --body "$BODY")
          NUM=$(echo "$URL" | sed -n 's#.*/issues/##p')
          gh issue edit "$NUM" --add-label "agent-run"

          # Start next agent without relying on issue event timing.
          gh workflow run agent_run.yml --ref main \
            -f pipeline_id="$PID" \
            -f work_item="$WI" \
            -f role="$NR" \
            -f task="$NT" \
            -f next_role="" \
            -f next_task="" \
            -f issue_number="$NUM"

          echo "[fd][agent] created next issue=$URL and dispatched next role=$NR"


      - name: Final cleanup (non-git)
        run: |
          set -e
          rm -f tools/_artifact_release_url.txt || true
          rm -f tools/next_issue_body.json || true
          rm -f tools/next_step.json || true
