name: fd-agent-run

on:
  workflow_dispatch:
    inputs:
      pipeline_id:
        description: "Pipeline id (example: P-20260225-001)"
        required: true
        default: "P-20260225-001"
      work_item:
        description: "Work Item ID (example: WI-001)"
        required: true
        default: "WI-001"
      role:
        description: "Role id (example: pm)"
        required: true
        default: "pm"
      task:
        description: "Task text"
        required: true
        default: "Define next step"
      next_role:
        description: "Next role id (empty means pipeline complete)"
        required: false
        default: "tech_lead"
      next_task:
        description: "Next task for next role"
        required: false
        default: "Define technical approach and WI decomposition"

  issues:
    types:
      - opened
      - edited
      - labeled

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  run:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-run'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build input payload
        run: |
          set -e
          mkdir -p tools
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            cat > tools/issue_input.json <<'JSON'
          {
            "pipeline_id": "${{ inputs.pipeline_id }}",
            "work_item": "${{ inputs.work_item }}",
            "role": "${{ inputs.role }}",
            "task": "${{ inputs.task }}",
            "next_role": "${{ inputs.next_role }}",
            "next_task": "${{ inputs.next_task }}",
            "actions": []
          }
          JSON
          else
            python tools/parse_github_event.py \
              --event-path "$GITHUB_EVENT_PATH" \
              --out tools/issue_input.json
          fi

      - name: Determine pipeline branch
        id: br
        run: |
          set -e
          pid=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['pipeline_id'])")
          echo "pid=$pid" >> $GITHUB_OUTPUT
          echo "branch=pipeline/$pid" >> $GITHUB_OUTPUT

      - name: Checkout or create pipeline branch
        run: |
          set -e
          BR="${{ steps.br.outputs.branch }}"
          git config user.name "fd-agent-bot"
          git config user.email "fd-agent-bot@users.noreply.github.com"
          if git show-ref --verify --quiet "refs/remotes/origin/$BR"; then
            git checkout -b "$BR" "origin/$BR"
          else
            git checkout -b "$BR"
          fi

      - name: Run agent pipeline
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['role'])")
          OUTDIR="evidence/${WI}/${ROLE}"
          mkdir -p "$OUTDIR"
          python tools/agent_pipeline.py --input tools/issue_input.json --out "$OUTDIR"

      - name: Upload agent artifacts (short retention)
        uses: actions/upload-artifact@v4
        with:
          name: fd-agent-artifacts
          retention-days: 1
          path: |
            evidence/**/ARTIFACTS.zip
            evidence/**/AGENT_OUTPUT.md
            evidence/**/AGENT_META.json

      - name: Cleanup ZIP artifacts before commit
        run: |
          set -e
          find evidence -type f -name "ARTIFACTS.zip" -print -delete || true

      - name: Commit artifacts to pipeline branch
        run: |
          set -e
          git add evidence tools/issue_input.json || true
          if [ -n "$(git status --porcelain)" ]; then
            WI=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['work_item'])")
            ROLE=$(python -c "import json;print(json.load(open('tools/issue_input.json'))['role'])")
            git commit -m "$WI $ROLE artifacts"
            git push origin "${{ steps.br.outputs.branch }}"
          fi
