name: fd-agent-run

on:
  workflow_dispatch:
    inputs:
      pipeline_id:
        description: "Pipeline id (example: P-20260225-001)"
        required: true
        default: "P-20260225-001"
        type: string
      work_item:
        description: "Work Item ID (example: WI-001)"
        required: true
        default: "WI-001"
        type: string
      role:
        description: "Role id (example: pm)"
        required: true
        default: "pm"
        type: string
      task:
        description: "Task text"
        required: true
        default: "Define next step"
        type: string
      next_role:
        description: "Next role id (empty means infer next role)"
        required: false
        default: ""
        type: string
      next_task:
        description: "Next task for next role (optional)"
        required: false
        default: ""
        type: string

  issues:
    types:
      - opened
      - edited
      - labeled

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  run:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-run'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build input payload (write to /tmp)
        run: |
          set -e
          TMP=/tmp/fd_issue_input.json
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            cat > "$TMP" <<'JSON'
          {
            "pipeline_id": "${{ inputs.pipeline_id }}",
            "work_item": "${{ inputs.work_item }}",
            "role": "${{ inputs.role }}",
            "task": "${{ inputs.task }}",
            "next_role": "${{ inputs.next_role }}",
            "next_task": "${{ inputs.next_task }}",
            "actions": []
          }
          JSON
          else
            python tools/parse_github_event.py \
              --event-path "$GITHUB_EVENT_PATH" \
              --out "$TMP"
          fi

      - name: Determine pipeline branch
        id: br
        run: |
          set -e
          pid=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          echo "pid=$pid" >> "$GITHUB_OUTPUT"
          echo "branch=pipeline/$pid" >> "$GITHUB_OUTPUT"

      - name: Checkout or create pipeline branch
        run: |
          set -e
          BR="${{ steps.br.outputs.branch }}"
          git config user.name "fd-agent-bot"
          git config user.email "fd-agent-bot@users.noreply.github.com"
          git fetch origin main
          if git show-ref --verify --quiet "refs/remotes/origin/$BR"; then
            git checkout -b "$BR" "origin/$BR"
          else
            git checkout -b "$BR" "origin/main"
          fi

      - name: Sync tools from main into pipeline branch
        run: |
          set -e
          git fetch origin main
          git checkout origin/main -- tools || true
          git checkout origin/main -- .github/workflows/agent_run.yml || true

      - name: Materialize issue_input.json into repo
        run: |
          set -e
          mkdir -p tools
          cp -f /tmp/fd_issue_input.json tools/issue_input.json

      - name: Run agent pipeline
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
          OUTDIR="evidence/${WI}/${ROLE}"
          mkdir -p "$OUTDIR"
          python tools/agent_pipeline.py --input tools/issue_input.json --out "$OUTDIR"

      - name: Upload agent artifacts (short retention)
        uses: actions/upload-artifact@v4
        with:
          name: fd-agent-artifacts
          retention-days: 1
          path: |
            evidence/**/ARTIFACTS.zip
            evidence/**/AGENT_OUTPUT.md
            evidence/**/AGENT_META.json

      - name: Cleanup ZIP artifacts before commit
        run: |
          set -e
          find evidence -type f -name "ARTIFACTS.zip" -print -delete || true
          rm -f tools/next_step.json || true
          rm -f tools/next_issue_body.json || true

      - name: Commit artifacts and changes to pipeline branch
        run: |
          set -e
          git add tools evidence .github/workflows/agent_run.yml || true
          if [ -n "$(git status --porcelain)" ]; then
            WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
            ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
            git commit -m "$WI $ROLE artifacts"
            git push origin "${{ steps.br.outputs.branch }}"
          fi

      - name: Comment back with run link (issues only)
        if: ${{ github.event_name == 'issues' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          ROLE=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['role'])")
          PID=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BR="pipeline/$PID"
          gh issue comment "${{ github.event.issue.number }}" --body "Agent ran role=$ROLE work_item=$WI pipeline=$PID. Pipeline branch: $BR. Download artifact 'fd-agent-artifacts' from the run: $RUN_URL"

      - name: Create next agent issue (issues only)
        if: ${{ github.event_name == 'issues' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          python tools/next_step.py > tools/next_step.json
          NR=$(python -c "import json;print(json.load(open('tools/next_step.json'))['next_role'])")
          NT=$(python -c "import json;print(json.load(open('tools/next_step.json'))['next_task'])")
          if [ -z "$NR" ]; then
            echo "[fd][agent] pipeline complete (no next role)"
            exit 0
          fi
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          TITLE="$WI next: $NR"
          python tools/build_next_issue_body.py \
            --issue-input tools/issue_input.json \
            --role "$NR" \
            --task "$NT" \
            --out tools/next_issue_body.json
          BODY=$(cat tools/next_issue_body.json)
          gh issue create --title "$TITLE" --body "$BODY" --label "agent-run"

      - name: Open PR when pipeline complete (issues only)
        if: ${{ github.event_name == 'issues' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          python tools/next_step.py > tools/next_step.json
          NR=$(python -c "import json;print(json.load(open('tools/next_step.json'))['next_role'])")
          if [ -n "$NR" ]; then
            echo "[fd][agent] pipeline not complete; PR not opened"
            exit 0
          fi
          PID=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['pipeline_id'])")
          WI=$(python -c "import json;print(json.load(open('/tmp/fd_issue_input.json'))['work_item'])")
          BR="pipeline/$PID"
          gh pr create --title "$WI pipeline complete ($PID)" --body "Pipeline $PID complete. Branch: $BR. CI must pass." --base main --head "$BR" || true
