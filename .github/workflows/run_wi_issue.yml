name: Run Work Item (Issue -> Gemini -> Release)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: GitHub issue number for WI
        required: true
      role_guide:
        description: Role guide file under agent_guides/
        required: true

concurrency:
  group: fd-wi-runner
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install gh if missing
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          if command -v gh >/dev/null 2>&1; then
            gh --version
          else
            sudo apt-get update
            sudo apt-get install -y gh
          fi
      - name: Clean Python bytecode
        run: |
          find . -type d -name __pycache__ -prune -exec rm -rf {} +
          find . -type f -name "*.pyc" -delete
      - name: Run WI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONDONTWRITEBYTECODE: "1"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python3 tools/orchestrator/run_wi_issue.py "${{ inputs.issue_number }}" "${{ inputs.role_guide }}"
      - name: Dispatch next WI
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python3 tools/orchestrator/dispatch_next_wi.py
